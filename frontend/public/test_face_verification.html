<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Verification Test</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        h1 {
            text-align: center;
            color: #ff791a;
        }
        .container {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }
        .image-box {
            flex: 1;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            background: #2a2a2a;
        }
        .image-box h3 {
            margin-top: 0;
            color: #ff791a;
        }
        .image-box img {
            width: 100%;
            height: auto;
            border-radius: 4px;
            border: 1px solid #444;
        }
        .canvas-container {
            position: relative;
            margin-top: 10px;
        }
        canvas {
            width: 100%;
            height: auto;
            border: 1px solid #444;
            border-radius: 4px;
        }
        .results {
            margin: 30px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 2px solid #333;
        }
        .results h2 {
            margin-top: 0;
            color: #ff791a;
        }
        .result-item {
            display: flex;
            justify-between;
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-label {
            font-weight: bold;
            color: #aaa;
        }
        .result-value {
            color: #fff;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }
        .status.loading {
            background: #555;
            color: #fff;
        }
        .status.match {
            background: #2d7f2d;
            color: #fff;
        }
        .status.no-match {
            background: #7f2d2d;
            color: #fff;
        }
        .progress {
            padding: 10px;
            margin: 10px 0;
            background: #333;
            border-radius: 4px;
            font-size: 14px;
            color: #aaa;
        }
        button {
            background: #ff791a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background: #ff8c3a;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .file-input-container {
            margin: 15px 0;
        }
        .file-input-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ff791a;
        }
        .file-input-container input[type="file"] {
            width: 100%;
            padding: 8px;
            background: #333;
            border: 2px solid #444;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
        }
        .file-input-container input[type="file"]:hover {
            border-color: #ff791a;
        }
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 8px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            margin: 20px auto;
        }
        .score-circle.match {
            border-color: #2d7f2d;
            color: #2d7f2d;
        }
        .score-circle.no-match {
            border-color: #7f2d2d;
            color: #7f2d2d;
        }
    </style>
</head>
<body>
    <h1>üîç Face Verification Test</h1>
    
    <div class="status loading" id="status">Loading models...</div>
    <div class="progress" id="progress"></div>

    <div class="container">
        <div class="image-box">
            <h3>Image 1</h3>
            <div class="file-input-container">
                <label for="file1">Choose Image 1:</label>
                <input type="file" id="file1" accept="image/*" onchange="handleFileSelect(1, event)">
            </div>
            <img id="img1" style="display: none;" alt="Test Image 1">
            <div class="canvas-container">
                <canvas id="canvas1"></canvas>
            </div>
        </div>
        <div class="image-box">
            <h3>Image 2</h3>
            <div class="file-input-container">
                <label for="file2">Choose Image 2:</label>
                <input type="file" id="file2" accept="image/*" onchange="handleFileSelect(2, event)">
            </div>
            <img id="img2" style="display: none;" alt="Test Image 2">
            <div class="canvas-container">
                <canvas id="canvas2"></canvas>
            </div>
        </div>
    </div>

    <div class="results" id="results" style="display: none;">
        <h2>üìä Verification Results</h2>
        <div class="score-circle" id="scoreCircle">0%</div>
        <div class="result-item">
            <span class="result-label">Faces Detected (Image 1):</span>
            <span class="result-value" id="faces1">-</span>
        </div>
        <div class="result-item">
            <span class="result-label">Faces Detected (Image 2):</span>
            <span class="result-value" id="faces2">-</span>
        </div>
        <div class="result-item">
            <span class="result-label">Euclidean Distance:</span>
            <span class="result-value" id="distance">-</span>
        </div>
        <div class="result-item">
            <span class="result-label">Match Threshold:</span>
            <span class="result-value" id="threshold">0.6</span>
        </div>
        <div class="result-item">
            <span class="result-label">Confidence Score:</span>
            <span class="result-value" id="confidence">-</span>
        </div>
        <div class="result-item">
            <span class="result-label">Match Result:</span>
            <span class="result-value" id="matchResult">-</span>
        </div>
    </div>

    <button id="testBtn" onclick="runTest()" disabled>Run Test</button>

    <script>
        const statusEl = document.getElementById('status');
        const progressEl = document.getElementById('progress');
        const resultsEl = document.getElementById('results');
        const testBtn = document.getElementById('testBtn');
        
        let modelsLoaded = false;
        let image1Loaded = false;
        let image2Loaded = false;

        function updateStatus(message, className = 'loading') {
            statusEl.textContent = message;
            statusEl.className = `status ${className}`;
        }

        function updateProgress(message) {
            progressEl.textContent = message;
        }

        function checkReadyToTest() {
            if (modelsLoaded && image1Loaded && image2Loaded) {
                testBtn.disabled = false;
                updateStatus('‚úÖ Ready to test! Click button to compare faces.', 'match');
            } else if (modelsLoaded) {
                testBtn.disabled = true;
                const missing = [];
                if (!image1Loaded) missing.push('Image 1');
                if (!image2Loaded) missing.push('Image 2');
                updateStatus(`‚ö†Ô∏è Please select ${missing.join(' and ')}`, 'loading');
            }
        }

        function handleFileSelect(imageNum, event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imgElement = document.getElementById(`img${imageNum}`);
                imgElement.src = e.target.result;
                imgElement.style.display = 'block';
                
                if (imageNum === 1) {
                    image1Loaded = true;
                } else {
                    image2Loaded = true;
                }
                
                console.log(`‚úÖ Image ${imageNum} loaded: ${file.name}`);
                checkReadyToTest();
            };
            reader.readAsDataURL(file);
        }

        async function loadModels() {
            try {
                updateProgress('Loading SSD MobileNet...');
                await faceapi.nets.ssdMobilenetv1.loadFromUri('/models');
                
                updateProgress('Loading Face Landmark Model...');
                await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
                
                updateProgress('Loading Face Recognition Model...');
                await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
                
                updateProgress('Loading Tiny Face Detector...');
                await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
                
                modelsLoaded = true;
                updateProgress('Models loaded! Now select two images to compare.');
                checkReadyToTest();
                
                console.log('‚úÖ All models loaded successfully');
            } catch (error) {
                updateStatus('‚ùå Failed to load models: ' + error.message, 'no-match');
                console.error('Model loading error:', error);
            }
        }

        async function detectFaces(imgElement, canvasElement) {
            console.log(`Detecting faces in ${imgElement.id}...`);
            
            // Try SSD MobileNet first
            let detections = await faceapi
                .detectAllFaces(imgElement, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.3 }))
                .withFaceLandmarks()
                .withFaceDescriptors();

            console.log(`SSD MobileNet detected ${detections.length} faces`);

            // Fallback to TinyFaceDetector
            if (detections.length === 0) {
                console.log('Trying TinyFaceDetector...');
                detections = await faceapi
                    .detectAllFaces(imgElement, new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.3 }))
                    .withFaceLandmarks()
                    .withFaceDescriptors();
                
                console.log(`TinyFaceDetector detected ${detections.length} faces`);
            }

            // Draw detections on canvas
            if (canvasElement) {
                const displaySize = { width: imgElement.width, height: imgElement.height };
                faceapi.matchDimensions(canvasElement, displaySize);
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvasElement.getContext('2d').clearRect(0, 0, canvasElement.width, canvasElement.height);
                faceapi.draw.drawDetections(canvasElement, resizedDetections);
                faceapi.draw.drawFaceLandmarks(canvasElement, resizedDetections);
            }

            return detections;
        }

        async function runTest() {
            if (!modelsLoaded) {
                alert('Models not loaded yet!');
                return;
            }

            try {
                updateStatus('üîç Detecting faces...', 'loading');
                resultsEl.style.display = 'none';

                const img1 = document.getElementById('img1');
                const img2 = document.getElementById('img2');
                const canvas1 = document.getElementById('canvas1');
                const canvas2 = document.getElementById('canvas2');

                // Detect faces
                updateProgress('Detecting faces in Image 1...');
                const faces1 = await detectFaces(img1, canvas1);
                
                updateProgress('Detecting faces in Image 2...');
                const faces2 = await detectFaces(img2, canvas2);

                document.getElementById('faces1').textContent = faces1.length;
                document.getElementById('faces2').textContent = faces2.length;

                if (faces1.length === 0 || faces2.length === 0) {
                    updateStatus('‚ùå No faces detected in one or both images', 'no-match');
                    resultsEl.style.display = 'block';
                    return;
                }

                // Compare faces
                updateProgress('Comparing face descriptors...');
                const descriptor1 = faces1[0].descriptor;
                const descriptor2 = faces2[0].descriptor;
                
                const distance = faceapi.euclideanDistance(descriptor1, descriptor2);
                const threshold = 0.6;
                const isMatch = distance < threshold;
                const confidence = Math.max(0, Math.min(100, (1 - distance) * 100));

                console.log('Face Comparison Results:');
                console.log('  Distance:', distance.toFixed(4));
                console.log('  Threshold:', threshold);
                console.log('  Confidence:', Math.round(confidence) + '%');
                console.log('  Match:', isMatch ? 'YES' : 'NO');

                // Display results
                document.getElementById('distance').textContent = distance.toFixed(4);
                document.getElementById('confidence').textContent = Math.round(confidence) + '%';
                document.getElementById('matchResult').textContent = isMatch ? '‚úÖ MATCH' : '‚ùå NO MATCH';
                
                const scoreCircle = document.getElementById('scoreCircle');
                scoreCircle.textContent = Math.round(confidence) + '%';
                scoreCircle.className = `score-circle ${isMatch ? 'match' : 'no-match'}`;

                updateStatus(
                    isMatch ? 'üéâ Faces MATCH!' : '‚ö†Ô∏è Faces DO NOT match',
                    isMatch ? 'match' : 'no-match'
                );
                updateProgress(`Distance: ${distance.toFixed(4)} | Threshold: ${threshold} | Confidence: ${Math.round(confidence)}%`);
                
                resultsEl.style.display = 'block';

            } catch (error) {
                updateStatus('‚ùå Error: ' + error.message, 'no-match');
                console.error('Test error:', error);
            }
        }

        // Load models on page load
        window.addEventListener('load', loadModels);
    </script>
</body>
</html>
